name: Build Citron for Linux

on:
  push:
    branches:
      - main

jobs:
  build-stable:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures all files are available, including citron.dwfsprof

      - name: Install dependencies
        run: |
          # Modify pacman.conf
          sed -i 's/DownloadUser/#DownloadUser/g' /etc/pacman.conf

          # Package type for x86_64
          PKG_TYPE="x86_64.pkg.tar.zst"

          # URLs for custom packages
          LLVM_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/llvm-libs-nano-$PKG_TYPE"
          FFMPEG_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/ffmpeg-mini-$PKG_TYPE"
          QT6_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/qt6-base-iculess-$PKG_TYPE"
          LIBXML_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/libxml2-iculess-$PKG_TYPE"

          # Install system packages
          pacman -Syu --noconfirm \
            aom base-devel boost boost-libs catch2 clang cmake curl dav1d \
            desktop-file-utils doxygen enet ffmpeg ffmpeg4.4 fmt gamemode git \
            glslang glu hidapi libass libdecor libfdk-aac libopusenc libva \
            libvpx libxi libxkbcommon-x11 libxss libzip mbedtls mbedtls2 mesa \
            meson nasm ninja nlohmann-json numactl patchelf pipewire-audio \
            pulseaudio pulseaudio-alsa python-pip qt6-base qt6ct qt6-multimedia \
            qt6-tools qt6-wayland sdl2 strace unzip vulkan-headers vulkan-nouveau \
            vulkan-radeon wget x264 x265 xcb-util-image xcb-util-renderutil \
            xcb-util-wm xorg-server-xvfb zip zsync

          # Architecture-specific packages for x86_64
          pacman -Syu --noconfirm vulkan-intel haskell-gnutls gcc13 svt-av1

          # Install custom packages
          wget --retry-connrefused --tries=30 "$LLVM_URL" -O ./llvm-libs.pkg.tar.zst
          wget --retry-connrefused --tries=30 "$FFMPEG_URL" -O ./ffmpeg-mini-$PKG_TYPE
          wget --retry-connrefused --tries=30 "$QT6_URL" -O ./qt6-base-iculess.pkg.tar.zst
          wget --retry-connrefused --tries=30 "$LIBXML_URL" -O ./libxml2-iculess.pkg.tar.zst
          pacman -U --noconfirm \
            ./qt6-base-iculess.pkg.tar.zst \
            ./libxml2-iculess.pkg.tar.zst \
            ./ffmpeg-mini-$PKG_TYPE \
            ./llvm-libs.pkg.tar.zst

          # Clean up
          rm -f ./qt6-base-iculess.pkg.tar.zst ./libxml2-iculess.pkg.tar.zst ./ffmpeg-mini-$PKG_TYPE ./llvm-libs.pkg.tar.zst

      - name: Build Citron Stable
        run: |
          # Set architecture flags for optimized variant
          export ARCH="x86_64"
          echo "Building stable optimized variant."
          ARCH_FLAGS="-march=x86-64-v3 -Ofast -flto=auto"

          # Clone stable repository
          echo "Cloning stable version from https://git.citron-emu.org/Citron/Citron"
          git clone https://git.citron-emu.org/Citron/Citron.git ./citron
          cd ./citron
          echo "Checking out commit 51800e249bc44bd13b528220a8e064c3744c05d1"
          git checkout 51800e249bc44bd13b528220a8e064c3744c05d1
          VERSION="v0.6.1"

          # Update .gitmodules with new URLs (only changing git.citron-emu.org ones)
          echo "Updating .gitmodules with new submodule URLs..."
          sed -i 's|url = https://git.citron-emu.org/Citron/breakpad.git|url = https://github.com/yuzu-mirror/breakpad|' .gitmodules
          sed -i 's|url = https://git.citron-emu.org/Citron/discord-rpc.git|url = https://github.com/yuzu-mirror/discord-rpc|' .gitmodules
          sed -i 's|url = https://git.citron-emu.org/Citron/dynarmic.git|url = https://github.com/yuzu-mirror/dynarmic|' .gitmodules
          sed -i 's|url = https://git.citron-emu.org/Citron/mbedtls.git|url = https://github.com/yuzu-mirror/mbedtls|' .gitmodules
          sed -i 's|url = https://git.citron-emu.org/Citron/oaknut.git|url = https://github.com/yuzu-mirror/oaknut|' .gitmodules
          sed -i 's|url = https://git.citron-emu.org/Citron/sirit.git|url = https://github.com/yuzu-mirror/sirit|' .gitmodules

          # Debug: Display updated .gitmodules
          echo "Updated .gitmodules contents:"
          cat .gitmodules

          # Initialize submodules
          echo "Initializing submodules..."
          git submodule update --init --recursive -j$(nproc)

          # Debug: Check directory structure
          echo "Listing contents of citron directory:"
          ls -la
          echo "Listing contents of src directory (if it exists):"
          ls -la src || echo "src directory not found"

          # Fix Boost ASIO only if src directory exists and contains .cpp files
          if [ -d "src" ] && [ -n "$(find src -type f -name '*.cpp' 2>/dev/null)" ]; then
            echo "Applying Boost ASIO fix..."
            find src -type f -name "*.cpp" -exec sed -i "s/boost::asio::io_service/boost::asio::io_context/g" {} \;
          else
            echo "Skipping Boost ASIO fix: src directory not found or contains no .cpp files"
          fi

          # Build Citron
          mkdir build && cd build
          cmake .. -GNinja \
            -DCITRON_USE_BUNDLED_VCPKG=OFF \
            -DCITRON_USE_BUNDLED_QT=OFF \
            -DUSE_SYSTEM_QT=ON \
            -DCITRON_USE_BUNDLED_FFMPEG=OFF \
            -DCITRON_USE_BUNDLED_SDL2=ON \
            -DCITRON_USE_EXTERNAL_SDL2=OFF \
            -DCITRON_TESTS=OFF \
            -DCITRON_CHECK_SUBMODULES=OFF \
            -DCITRON_USE_LLVM_DEMANGLE=OFF \
            -DCITRON_ENABLE_LTO=ON \
            -DCITRON_USE_QT_MULTIMEDIA=OFF \
            -DCITRON_USE_QT_WEB_ENGINE=OFF \
            -DENABLE_QT_TRANSLATION=ON \
            -DUSE_DISCORD_PRESENCE=OFF \
            -DBUNDLE_SPEEX=ON \
            -DCITRON_USE_FASTER_LD=OFF \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_CXX_FLAGS="$ARCH_FLAGS -Wno-error -w" \
            -DCMAKE_C_FLAGS="$ARCH_FLAGS" \
            -DCMAKE_SYSTEM_PROCESSOR=x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          ninja
          ninja install
          cd ../..
          echo "$VERSION" > version.txt

      - name: Create AppImage Stable
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          VERSION=$(cat version.txt)
          ARCH="x86_64"
          ARCH_NAME="optimized"

          # Set up AppDir
          mkdir ./AppDir
          cd ./AppDir
          cp /usr/share/applications/org.citron_emu.citron.desktop ./citron.desktop
          cp /usr/share/icons/hicolor/scalable/apps/org.citron_emu.citron.svg ./citron.svg
          ln -s ./citron.svg ./.DirIcon
          sed -i "s|Name=citron|Name=citron stable|" ./citron.desktop

          # Define update info
          UPINFO="gh-releases-zsync|$(echo "$GITHUB_REPOSITORY" | tr '/' '|')|stable-optimized|*$ARCH_NAME.AppImage.zsync"

          # Download lib4bin
          wget --retry-connrefused --tries=30 "https://raw.githubusercontent.com/VHSgunzo/sharun/refs/heads/main/lib4bin" -O ./lib4bin
          chmod +x ./lib4bin

          # Create a script for lib4bin to ensure proper formatting and add debugging
          cat << 'EOF' > bundle-libs.sh
          #!/bin/bash
          set -e
          echo "Listing ALSA libraries before bundling:"
          ls -l /usr/lib/alsa-lib/ || echo "ALSA directory not found"

          # Run lib4bin with verbose output
          xvfb-run -a -- ./lib4bin -p -v -e -s -k \
            /usr/bin/citron* \
            /usr/lib/libGLX* \
            /usr/lib/libGL.so* \
            /usr/lib/libEGL* \
            /usr/lib/dri/* \
            /usr/lib/vdpau/* \
            /usr/lib/libvulkan* \
            /usr/lib/libXss.so* \
            /usr/lib/libdecor-0.so* \
            /usr/lib/libgamemode.so* \
            /usr/lib/qt6/plugins/audio/* \
            /usr/lib/qt6/plugins/bearer/* \
            /usr/lib/qt6/plugins/imageformats/* \
            /usr/lib/qt6/plugins/iconengines/* \
            /usr/lib/qt6/plugins/platforms/* \
            /usr/lib/qt6/plugins/platformthemes/* \
            /usr/lib/qt6/plugins/platforminputcontexts/* \
            /usr/lib/qt6/plugins/styles/* \
            /usr/lib/qt6/plugins/xcbglintegrations/* \
            /usr/lib/qt6/plugins/wayland-*/* \
            /usr/lib/pulseaudio/* \
            /usr/lib/pipewire-0.3/* \
            /usr/lib/spa-0.2/*/* \
            /usr/lib/alsa-lib/*

          # Check for temporary scripts in /__w/_temp/
          echo "Listing temporary scripts after lib4bin:"
          ls -l /__w/_temp/ || echo "No temporary scripts found"
          if [ -d /__w/_temp ]; then
            for script in /__w/_temp/*.sh; do
              if [ -f "$script" ]; then
                echo "Contents of $script:"
                cat "$script"
              fi
            done
          fi
          EOF

          # Make the script executable and run it
          chmod +x bundle-libs.sh
          echo "Running bundle-libs.sh..."
          ./bundle-libs.sh || {
            echo "lib4bin failed. Checking for temporary scripts..."
            ls -l /__w/_temp/ || echo "No temporary scripts found"
            exit 1
          }

          # Configure AppRun
          ln ./sharun ./AppRun
          ./sharun -g

          # Create AppImage
          cd ..
          wget -q "https://github.com/VHSgunzo/uruntime/releases/latest/download/uruntime-appimage-dwarfs-$ARCH" -O ./uruntime
          chmod +x ./uruntime
          ./uruntime --appimage-addupdinfo "$UPINFO"
          ./uruntime --appimage-mkdwarfs -f \
            --set-owner 0 --set-group 0 \
            --no-history --no-create-timestamp \
            --categorize=hotness --hotness-list=citron.dwfsprof \
            --compression zstd:level=22 -S26 -B32 \
            --header uruntime \
            -i ./AppDir -o Citron-"$VERSION"-anylinux-"$ARCH_NAME".AppImage

          # Generate zsync
          zsyncmake *.AppImage -u *.AppImage

      - name: Debug Token and Permissions
        env:
          CITRON_RELEASE_TOKEN: ${{ secrets.CITRON_RELEASE_TOKEN }}
        run: |
          # Check if CITRON_RELEASE_TOKEN is set
          if [ -z "$CITRON_RELEASE_TOKEN" ]; then
            echo "Error: CITRON_RELEASE_TOKEN is not set. Please add it to the repository secrets."
            exit 1
          else
            echo "CITRON_RELEASE_TOKEN is set (length: ${#CITRON_RELEASE_TOKEN} characters)."
          fi

          # Test the token by fetching user info (to verify it works)
          echo "Testing CITRON_RELEASE_TOKEN by fetching user info..."
          USER_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/user")
          echo "User response: $USER_RESPONSE"

          # Check if the token has access to zqpvr/citron-builds
          echo "Checking access to zqpvr/citron-builds..."
          REPO_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds")
          echo "Repo response: $REPO_RESPONSE"

          # Check for specific permissions (requires the token to have repo scope)
          PERMS_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/zqpvr/citron-builds/collaborators/$(echo "$USER_RESPONSE" | grep '"login":' | sed -E 's/.*"login": "([^"]+)".*/\1/')/permission")
          echo "Permissions response: $PERMS_RESPONSE"

      - name: Create or Update Stable Release
        env:
          CITRON_RELEASE_TOKEN: ${{ secrets.CITRON_RELEASE_TOKEN }}
        run: |
          VERSION=$(cat version.txt)
          RELEASE_TAG="v0.6.1"

          # Check if the release exists in zqpvr/citron-builds
          echo "Checking if release $RELEASE_TAG exists..."
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds/releases/tags/$RELEASE_TAG")
          echo "Release response: $RELEASE_RESPONSE"

          # Extract release ID if it exists
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep '"id":' | head -1 | sed -E 's/.*"id": ([0-9]+),.*/\1/')

          if [ -n "$RELEASE_ID" ]; then
            echo "Stable release $RELEASE_TAG exists, deleting old assets..."
            # Get list of assets
            ASSETS_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID/assets")
            echo "Assets response: $ASSETS_RESPONSE"
            ASSET_IDS=$(echo "$ASSETS_RESPONSE" | grep '"id":' | sed -E 's/.*"id": ([0-9]+),.*/\1/')

            # Delete each asset
            for ASSET_ID in $ASSET_IDS; do
              echo "Deleting asset ID $ASSET_ID..."
              DELETE_RESPONSE=$(curl -s -X DELETE -H "Authorization: token $CITRON_RELEASE_TOKEN" \
                "https://api.github.com/repos/zqpvr/citron-builds/releases/assets/$ASSET_ID")
              echo "Delete response for asset $ASSET_ID: $DELETE_RESPONSE"
            done

            echo "Updating existing release..."
            UPDATE_RESPONSE=$(curl -s -X PATCH -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID" \
              -d "{\"name\": \"Stable Build (Version: $VERSION)\", \"prerelease\": false}")
            echo "Update response: $UPDATE_RESPONSE"
            if echo "$UPDATE_RESPONSE" | grep -q '"message":'; then
              echo "Error updating release: $UPDATE_RESPONSE"
              exit 1
            fi
          else
            echo "Creating new stable release $RELEASE_TAG..."
            CREATE_RESPONSE=$(curl -s -X POST -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases" \
              -d "{\"tag_name\": \"$RELEASE_TAG\", \"name\": \"Stable Build (Version: $VERSION)\", \"prerelease\": false}")
            echo "Create response: $CREATE_RESPONSE"
            if echo "$CREATE_RESPONSE" | grep -q '"message":'; then
              echo "Error creating release: $CREATE_RESPONSE"
              exit 1
            fi
          fi

          # Get the updated release ID
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds/releases/tags/$RELEASE_TAG")
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep '"id":' | head -1 | sed -E 's/.*"id": ([0-9]+),.*/\1/')

          # Upload new assets
          for ASSET in Citron-*.AppImage*; do
            echo "Uploading $ASSET..."
            UPLOAD_RESPONSE=$(curl -s -X POST -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$ASSET" \
              "https://uploads.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID/assets?name=$(basename "$ASSET")")
            echo "Upload response for $ASSET: $UPLOAD_RESPONSE"
            if echo "$UPLOAD_RESPONSE" | grep -q '"message":'; then
              echo "Error uploading $ASSET: $UPLOAD_RESPONSE"
              exit 1
            fi
          done

  build-nightly:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures all files are available, including citron.dwfsprof

      - name: Install dependencies
        run: |
          # Modify pacman.conf
          sed -i 's/DownloadUser/#DownloadUser/g' /etc/pacman.conf

          # Package type for x86_64
          PKG_TYPE="x86_64.pkg.tar.zst"

          # URLs for custom packages
          LLVM_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/llvm-libs-nano-$PKG_TYPE"
          FFMPEG_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/ffmpeg-mini-$PKG_TYPE"
          QT6_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/qt6-base-iculess-$PKG_TYPE"
          LIBXML_URL="https://github.com/pkgforge-dev/llvm-libs-debloated/releases/download/continuous/libxml2-iculess-$PKG_TYPE"

          # Install system packages
          pacman -Syu --noconfirm \
            aom base-devel boost boost-libs catch2 clang cmake curl dav1d \
            desktop-file-utils doxygen enet ffmpeg ffmpeg4.4 fmt gamemode git \
            glslang glu hidapi libass libdecor libfdk-aac libopusenc libva \
            libvpx libxi libxkbcommon-x11 libxss libzip mbedtls mbedtls2 mesa \
            meson nasm ninja nlohmann-json numactl patchelf pipewire-audio \
            pulseaudio pulseaudio-alsa python-pip qt6-base qt6ct qt6-multimedia \
            qt6-tools qt6-wayland sdl2 strace unzip vulkan-headers vulkan-nouveau \
            vulkan-radeon wget x264 x265 xcb-util-image xcb-util-renderutil \
            xcb-util-wm xorg-server-xvfb zip zsync

          # Architecture-specific packages for x86_64
          pacman -Syu --noconfirm vulkan-intel haskell-gnutls gcc13 svt-av1

          # Install custom packages
          wget --retry-connrefused --tries=30 "$LLVM_URL" -O ./llvm-libs.pkg.tar.zst
          wget --retry-connrefused --tries=30 "$FFMPEG_URL" -O ./ffmpeg-mini-$PKG_TYPE
          wget --retry-connrefused --tries=30 "$QT6_URL" -O ./qt6-base-iculess.pkg.tar.zst
          wget --retry-connrefused --tries=30 "$LIBXML_URL" -O ./libxml2-iculess.pkg.tar.zst
          pacman -U --noconfirm \
            ./qt6-base-iculess.pkg.tar.zst \
            ./libxml2-iculess.pkg.tar.zst \
            ./ffmpeg-mini-$PKG_TYPE \
            ./llvm-libs.pkg.tar.zst

          # Clean up
          rm -f ./qt6-base-iculess.pkg.tar.zst ./libxml2-iculess.pkg.tar.zst ./ffmpeg-mini-$PKG_TYPE ./llvm-libs.pkg.tar.zst

      - name: Build Citron Nightly
        run: |
          # Set architecture flags for optimized variant
          export ARCH="x86_64"
          echo "Building nightly optimized variant."
          ARCH_FLAGS="-march=x86-64-v3 -Ofast -flto=auto"

          # Clone nightly repository
          echo "Cloning nightly version from https://git.citron-emu.org/Citron/Citron"
          git clone https://git.citron-emu.org/Citron/Citron.git ./citron
          cd ./citron
          echo "Checking out commit 19febba866d227cc16f8b3c814d6d5ae06c4d7a7"
          git checkout 19febba866d227cc16f8b3c814d6d5ae06c4d7a7
          VERSION=$(git rev-parse --short=10 HEAD)
          FULL_COMMIT=$(git rev-parse HEAD)

          # Initialize submodules
          echo "Initializing submodules..."
          git submodule update --init --recursive -j$(nproc)

          # Debug: Check directory structure
          echo "Listing contents of citron directory:"
          ls -la
          echo "Listing contents of src directory (if it exists):"
          ls -la src || echo "src directory not found"

          # Fix Boost ASIO only if src directory exists and contains .cpp files
          if [ -d "src" ] && [ -n "$(find src -type f -name '*.cpp' 2>/dev/null)" ]; then
            echo "Applying Boost ASIO fix..."
            find src -type f -name "*.cpp" -exec sed -i "s/boost::asio::io_service/boost::asio::io_context/g" {} \;
          else
            echo "Skipping Boost ASIO fix: src directory not found or contains no .cpp files"
          fi

          # Build Citron
          mkdir build && cd build
          cmake .. -GNinja \
            -DCITRON_USE_BUNDLED_VCPKG=OFF \
            -DCITRON_USE_BUNDLED_QT=OFF \
            -DUSE_SYSTEM_QT=ON \
            -DCITRON_USE_BUNDLED_FFMPEG=OFF \
            -DCITRON_USE_BUNDLED_SDL2=ON \
            -DCITRON_USE_EXTERNAL_SDL2=OFF \
            -DCITRON_TESTS=OFF \
            -DCITRON_CHECK_SUBMODULES=OFF \
            -DCITRON_USE_LLVM_DEMANGLE=OFF \
            -DCITRON_ENABLE_LTO=ON \
            -DCITRON_USE_QT_MULTIMEDIA=OFF \
            -DCITRON_USE_QT_WEB_ENGINE=OFF \
            -DENABLE_QT_TRANSLATION=ON \
            -DUSE_DISCORD_PRESENCE=OFF \
            -DBUNDLE_SPEEX=ON \
            -DCITRON_USE_FASTER_LD=OFF \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_CXX_FLAGS="$ARCH_FLAGS -Wno-error -w" \
            -DCMAKE_C_FLAGS="$ARCH_FLAGS" \
            -DCMAKE_SYSTEM_PROCESSOR=x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          ninja
          ninja install
          cd ../..
          echo "$VERSION" > version.txt
          echo "$FULL_COMMIT" > full_commit.txt

      - name: Create AppImage Nightly
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          VERSION=$(cat version.txt)
          FULL_COMMIT=$(cat full_commit.txt)
          ARCH="x86_64"
          ARCH_NAME="optimized"

          # Set up AppDir
          mkdir ./AppDir
          cd ./AppDir
          cp /usr/share/applications/org.citron_emu.citron.desktop ./citron.desktop
          cp /usr/share/icons/hicolor/scalable/apps/org.citron_emu.citron.svg ./citron.svg
          ln -s ./citron.svg ./.DirIcon
          sed -i "s|Name=citron|Name=citron nightly|" ./citron.desktop

          # Define update info
          UPINFO="gh-releases-zsync|$(echo "$GITHUB_REPOSITORY" | tr '/' '|')|nightly-optimized|*$ARCH_NAME.AppImage.zsync"

          # Download lib4bin
          wget --retry-connrefused --tries=30 "https://raw.githubusercontent.com/VHSgunzo/sharun/refs/heads/main/lib4bin" -O ./lib4bin
          chmod +x ./lib4bin

          # Create a script for lib4bin to ensure proper formatting and add debugging
          cat << 'EOF' > bundle-libs.sh
          #!/bin/bash
          set -e
          echo "Listing ALSA libraries before bundling:"
          ls -l /usr/lib/alsa-lib/ || echo "ALSA directory not found"

          # Run lib4bin with verbose output
          xvfb-run -a -- ./lib4bin -p -v -e -s -k \
            /usr/bin/citron* \
            /usr/lib/libGLX* \
            /usr/lib/libGL.so* \
            /usr/lib/libEGL* \
            /usr/lib/dri/* \
            /usr/lib/vdpau/* \
            /usr/lib/libvulkan* \
            /usr/lib/libXss.so* \
            /usr/lib/libdecor-0.so* \
            /usr/lib/libgamemode.so* \
            /usr/lib/qt6/plugins/audio/* \
            /usr/lib/qt6/plugins/bearer/* \
            /usr/lib/qt6/plugins/imageformats/* \
            /usr/lib/qt6/plugins/iconengines/* \
            /usr/lib/qt6/plugins/platforms/* \
            /usr/lib/qt6/plugins/platformthemes/* \
            /usr/lib/qt6/plugins/platforminputcontexts/* \
            /usr/lib/qt6/plugins/styles/* \
            /usr/lib/qt6/plugins/xcbglintegrations/* \
            /usr/lib/qt6/plugins/wayland-*/* \
            /usr/lib/pulseaudio/* \
            /usr/lib/pipewire-0.3/* \
            /usr/lib/spa-0.2/*/* \
            /usr/lib/alsa-lib/*

          # Check for temporary scripts in /__w/_temp/
          echo "Listing temporary scripts after lib4bin:"
          ls -l /__w/_temp/ || echo "No temporary scripts found"
          if [ -d /__w/_temp ]; then
            for script in /__w/_temp/*.sh; do
              if [ -f "$script" ]; then
                echo "Contents of $script:"
                cat "$script"
              fi
            done
          fi
          EOF

          # Make the script executable and run it
          chmod +x bundle-libs.sh
          echo "Running bundle-libs.sh..."
          ./bundle-libs.sh || {
            echo "lib4bin failed. Checking for temporary scripts..."
            ls -l /__w/_temp/ || echo "No temporary scripts found"
            exit 1
          }

          # Configure AppRun
          ln ./sharun ./AppRun
          ./sharun -g

          # Create AppImage
          cd ..
          wget -q "https://github.com/VHSgunzo/uruntime/releases/latest/download/uruntime-appimage-dwarfs-$ARCH" -O ./uruntime
          chmod +x ./uruntime
          ./uruntime --appimage-addupdinfo "$UPINFO"
          ./uruntime --appimage-mkdwarfs -f \
            --set-owner 0 --set-group 0 \
            --no-history --no-create-timestamp \
            --categorize=hotness --hotness-list=citron.dwfsprof \
            --compression zstd:level=22 -S26 -B32 \
            --header uruntime \
            -i ./AppDir -o Citron-"$VERSION"-anylinux-"$ARCH_NAME".AppImage

          # Generate zsync
          zsyncmake *.AppImage -u *.AppImage

      - name: Debug Token and Permissions (Nightly)
        env:
          CITRON_RELEASE_TOKEN: ${{ secrets.CITRON_RELEASE_TOKEN }}
        run: |
          # Check if CITRON_RELEASE_TOKEN is set
          if [ -z "$CITRON_RELEASE_TOKEN" ]; then
            echo "Error: CITRON_RELEASE_TOKEN is not set. Please add it to the repository secrets."
            exit 1
          else
            echo "CITRON_RELEASE_TOKEN is set (length: ${#CITRON_RELEASE_TOKEN} characters)."
          fi

          # Test the token by fetching user info (to verify it works)
          echo "Testing CITRON_RELEASE_TOKEN by fetching user info..."
          USER_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/user")
          echo "User response: $USER_RESPONSE"

          # Check if the token has access to zqpvr/citron-builds
          echo "Checking access to zqpvr/citron-builds..."
          REPO_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds")
          echo "Repo response: $REPO_RESPONSE"

          # Check for specific permissions (requires the token to have repo scope)
          PERMS_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/zqpvr/citron-builds/collaborators/$(echo "$USER_RESPONSE" | grep '"login":' | sed -E 's/.*"login": "([^"]+)".*/\1/')/permission")
          echo "Permissions response: $PERMS_RESPONSE"

      - name: Create or Update Nightly Release
        env:
          CITRON_RELEASE_TOKEN: ${{ secrets.CITRON_RELEASE_TOKEN }}
        run: |
          VERSION=$(cat version.txt)
          FULL_COMMIT=$(cat full_commit.txt)

          # Check if the nightly release exists in zqpvr/citron-builds
          echo "Checking if nightly release exists..."
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds/releases/tags/nightly")
          echo "Release response: $RELEASE_RESPONSE"

          # Extract release ID if it exists
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep '"id":' | head -1 | sed -E 's/.*"id": ([0-9]+),.*/\1/')

          if [ -n "$RELEASE_ID" ]; then
            echo "Nightly release exists, deleting old assets..."
            # Get list of assets
            ASSETS_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID/assets")
            echo "Assets response: $ASSETS_RESPONSE"
            ASSET_IDS=$(echo "$ASSETS_RESPONSE" | grep '"id":' | sed -E 's/.*"id": ([0-9]+),.*/\1/')

            # Delete each asset
            for ASSET_ID in $ASSET_IDS; do
              echo "Deleting asset ID $ASSET_ID..."
              DELETE_RESPONSE=$(curl -s -X DELETE -H "Authorization: token $CITRON_RELEASE_TOKEN" \
                "https://api.github.com/repos/zqpvr/citron-builds/releases/assets/$ASSET_ID")
              echo "Delete response for asset $ASSET_ID: $DELETE_RESPONSE"
            done

            echo "Updating existing release..."
            UPDATE_RESPONSE=$(curl -s -X PATCH -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID" \
              -d "{\"name\": \"Continuous Build (Nightly Version: $VERSION)\", \"prerelease\": true}")
            echo "Update response: $UPDATE_RESPONSE"
            if echo "$UPDATE_RESPONSE" | grep -q '"message":'; then
              echo "Error updating release: $UPDATE_RESPONSE"
              exit 1
            fi
          else
            echo "Creating new nightly release..."
            CREATE_RESPONSE=$(curl -s -X POST -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/zqpvr/citron-builds/releases" \
              -d "{\"tag_name\": \"nightly\", \"name\": \"Continuous Build (Nightly Version: $VERSION)\", \"body\": \"Commit: $FULL_COMMIT\", \"prerelease\": true}") # Added commit to body
            echo "Create response: $CREATE_RESPONSE"
            if echo "$CREATE_RESPONSE" | grep -q '"message":'; then
              echo "Error creating release: $CREATE_RESPONSE"
              exit 1
            fi
          fi

          # Get the updated release ID
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token $CITRON_RELEASE_TOKEN" \
            "https://api.github.com/repos/zqpvr/citron-builds/releases/tags/nightly")
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep '"id":' | head -1 | sed -E 's/.*"id": ([0-9]+),.*/\1/')

          # Upload new assets
          for ASSET in Citron-*.AppImage*; do
            echo "Uploading $ASSET..."
            UPLOAD_RESPONSE=$(curl -s -X POST -H "Authorization: token $CITRON_RELEASE_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$ASSET" \
              "https://uploads.github.com/repos/zqpvr/citron-builds/releases/$RELEASE_ID/assets?name=$(basename "$ASSET")")
            echo "Upload response for $ASSET: $UPLOAD_RESPONSE"
            if echo "$UPLOAD_RESPONSE" | grep -q '"message":'; then
              echo "Error uploading $ASSET: $UPLOAD_RESPONSE"
              exit 1
            fi
          done
